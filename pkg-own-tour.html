<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Ayubowan Tours</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600&family=Roboto&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600&family=Roboto&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for capturing map -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* WhatsApp Floating Button with Pulse Animation */
        .whatsapp-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-color: #25D366;
            color: #fff;
            border-radius: 50%;
            font-size: 42px;
            text-align: center;
            line-height: 80px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.35);
            z-index: 1000;
            animation: whatsapp-pulse 1.8s infinite;
            text-decoration: none;
        }

        /* Hover effect */
        .whatsapp-float:hover {
            transform: scale(1.1);
            transition: 0.3s ease;
        }

        /* Pulse animation */
        @keyframes whatsapp-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
            }

            70% {
                box-shadow: 0 0 0 25px rgba(37, 211, 102, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .whatsapp-float {
                width: 70px;
                height: 70px;
                font-size: 38px;
                line-height: 70px;
                bottom: 15px;
                right: 15px;
            }
        }

        .flex-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 30px 0;
        }

        .box {
            background: #fff;
            border: 2px dashed #bbb;
            border-radius: 10px;
            padding: 15px;
            max-width: 420px;
            flex: 1 1 320px;
            position: relative;
            min-height: 300px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            min-height: 200px;
        }

        .item {
            background: linear-gradient(135deg, #fff, #eef3ff);
            padding: 6px;
            border-radius: 8px;
            text-align: center;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
            z-index: 2;
        }

        .item.dragging {
            opacity: 0.7;
            transform: scale(1.05);
            cursor: grabbing;
        }

        .item img {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: 5px;
        }

        .traveler-info {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #3498db;
        }

        .invalid {
            border-color: red !important;
        }

        .valid {
            border-color: green !important;
        }

        .validation-message {
            font-size: 0.8rem;
            color: red;
            display: none;
            margin-bottom: 5px;
        }

        .validation-message.show {
            display: block;
        }

        #map {
            width: 100%;
            height: 350px;
            margin-top: 10px;
            border-radius: 8px;
            z-index: 1;
        }

        .map-container {
            position: relative;
            margin: 10px 0;
        }

        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .popup-box {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Custom scalable animated pin */
        .pin-icon {
            position: relative;
            width: 36px;
            height: 46px;
            border-radius: 50% 50% 50% 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            animation: pulse 2s infinite ease-in-out;
        }

        .pin-icon::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: inherit;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 4px 14px rgba(0, 0, 0, 0.5);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            }
        }

        .hidden-for-export {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 600px;
            height: 400px;
            z-index: -9999;
        }

        /* Empty state messages */
        .empty-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 1.2rem;
            text-align: center;
            width: 80%;
            z-index: 1;
            animation: fadeInOut 2s infinite alternate;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .empty-message i {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
            color: #3498db;
        }

        /* Enhanced styling for PDF */
        .download-summary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: bold;
        }

        .download-summary-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* Booking confirmation popup */
        .popup-content {
            padding: 20px;
        }

        .popup-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 15px;
            animation: pop 0.5s ease;
        }

        @keyframes pop {
            0% {
                transform: scale(0);
            }

            70% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .summary-btn-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ddd;
        }

        /* Spinner styles */
        #spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        #spinner.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>

<body>

    <!-- Spinner Start - Fixed to show/hide properly -->
    <div id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->

    <!-- Navbar & Hero Start -->
    <div class="container-fluid position-relative p-0">
        <nav class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
            <a href="./index.html" class="navbar-brand p-0">
                <h1 class="m-0"><i class="fa fa-map-marker-alt me-3"></i>Ayubowan Tours</h1>
                <!-- <img src="img/logo.png" alt="Logo"> -->
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="fa fa-bars"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto py-0">
                    <a href="index.html" class="nav-item nav-link">Home</a>
                    <a href="about.html" class="nav-item nav-link">About</a>
                    <a href="services.html" class="nav-item nav-link">Services</a>
                    <a href="packages.html" class="nav-item nav-link active">Packages</a>
                    <a href="blog.html" class="nav-item nav-link">Blog</a>
                    <a href="contact.html" class="nav-item nav-link">Contact</a>
                </div>
                <a href="./booking.html" class="btn btn-primary rounded-pill py-2 px-4 ms-lg-4">Book My Tour</a>
            </div>
        </nav>
    </div>
    <!-- Navbar & Hero End -->

    <!-- Header Start -->
    <div class="container-fluid bg-breadcrumb">
        <div class="container text-center py-5" style="max-width: 900px;">
            <h3 class="text-white display-3 mb-4">Design Your Sri Lanka journey</h3>
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item"><a href="packages.html">Packages</a></li>
                <li class="breadcrumb-item active text-white">Design Your Sri Lanka journey</li>
            </ol>
        </div>
    </div>
    <!-- Header End -->

    <div class="container-fluid blog py-5">
        <div>
            <div class="mx-auto text-center mb-5" style="max-width: 900px;">
                <h5 class="section-title px-3">Design Your Sri Lanka Journey</h5>
                <p class="mb-0">Create your perfect Sri Lanka getaway with ease, simply click or drag destinations to
                    build your ideal journey. When you're happy with your selection, fill in your travel details
                    and send your request via WhatsApp or email. Our expert team will carefully review your itinerary
                    and get in touch soon to plan the next exciting steps of your adventure.
                </p>
            </div>

            <div class="flex-container">
                <!-- Available Places -->
                <div class="box">
                    <h3 class="text-center">Explore Destinations</h3>
                    <div class="items-grid" id="availableGrid">
                        <div class="item" data-id="Kandy"><img src="img/kandy-package-card.jpeg" alt="Kandy">
                            <div>Kandy</div>
                        </div>
                        <div class="item" data-id="Sigiriya"><img src="img/kandy-dambulla-sirigiya-package-card.jpg"
                                alt="Sigiriya">
                            <div>Sigiriya</div>
                        </div>
                        <div class="item" data-id="Ella"><img src="img/14-day-tour-srilanka-ella.jpg" alt="Ella">
                            <div>Ella</div>
                        </div>
                        <div class="item" data-id="Yala"><img src="img/14-day-tour-srilanka-yala.jpg" alt="Yala Safari">
                            <div>Yala Safari</div>
                        </div>
                        <div class="item" data-id="Galle"><img src="img/14-day-tour-srilanka-galle.jpg" alt="Galle">
                            <div>Galle</div>
                        </div>
                    </div>
                    <div class="empty-message" id="availableEmptyMessage">
                        <i class="fas fa-exclamation-circle"></i>
                        No Options Available
                    </div>
                </div>

                <!-- Selected Places -->
                <div class="box">
                    <h3 class="text-center">Your Selected Journey</h3>
                    <div class="items-grid" id="selectedGrid"></div>
                    <div class="empty-message" id="selectedEmptyMessage">
                        <i class="fas fa-mouse-pointer"></i>
                        Click To Select Destinations
                    </div>
                </div>

                <!-- Booking Details -->
                <div class="traveler-info">
                    <h3>Complete Your Travel Details</h3>
                    <p class="mb-4" style="color: #3498db;">
                        Share your details to confirm your journey and begin planning.
                    </p>

                    <input class="form-control mb-1" id="name" placeholder="Full Name *">
                    <div class="validation-message" id="nameMsg">Please enter your full name</div>

                    <input class="form-control mb-1" id="phone" placeholder="Phone Number *">
                    <div class="validation-message" id="phoneMsg">Please enter a valid phone number (7-15 digits)</div>

                    <input class="form-control mb-1" id="email" placeholder="Email Address *">
                    <div class="validation-message" id="emailMsg">Please enter a valid email address</div>

                    <input class="form-control mb-1" type="number" id="adults" min="1" placeholder="Number of Adults *">
                    <div class="validation-message" id="adultsMsg">At least 1 adult is required</div>

                    <input class="form-control mb-1" type="number" id="children" min="0" value="0"
                        placeholder="Number of Children">

                    <label class="mt-2">Arrival Date *</label>
                    <input class="form-control mb-1" type="date" id="arrival">
                    <div class="validation-message" id="arrivalMsg">Please select an arrival date</div>

                    <label>Departure Date *</label>
                    <input class="form-control mb-1" type="date" id="departure">
                    <div class="validation-message" id="departureMsg">Please select a departure date after arrival date
                    </div>

                    <!-- Map -->
                    <div class="map-container">
                        <div id="map"></div>
                    </div>

                    <button class="btn btn-success w-100 mt-3" id="sendWhatsApp" disabled>
                        <i class="fa-brands fa-whatsapp"></i> Send Booking via WhatsApp
                    </button>
                    <button class="btn btn-primary w-100 mt-2" id="sendEmail" disabled>
                        <i class="fa fa-envelope"></i> Send Booking via Email
                    </button>
                    <button class="btn btn-info w-100 mt-2" id="generatePDF" disabled>
                        <i class="fa fa-file-pdf"></i> Download Travel Summary PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden map for PDF export -->
    <div id="mapForExport" class="hidden-for-export"></div>

    <!-- Booking Confirmation Popup -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-box">
            <div class="popup-content">
                <div class="popup-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4>Booking Confirmed!</h4>
                <p>Your booking request has been successfully submitted.</p>
                <p><small>We will contact you shortly to finalize your tour details.</small></p>

                <div class="summary-btn-container">
                    <p>Download your booking summary:</p>
                    <button class="btn download-summary-btn w-100" id="downloadSummaryPDF">
                        <i class="fas fa-download"></i> Download Booking Summary PDF
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-muted">This popup will auto-close in <span id="countdown">5</span>
                        seconds</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscribe Start -->
    <div class="container-fluid subscribe py-5">
        <div class="container text-center py-5">
            <div class="mx-auto text-center" style="max-width: 900px;">
                <h5 class="subscribe-title px-3">Subscribe</h5>
                <h1 class="text-white mb-4">Our Newsletter</h1>
                <p class="text-white mb-5">Subscribe to our newsletter and receive exclusive travel deals,
                    insider tips, and inspiring Sri Lanka travel stories straight to your inbox.
                </p>
                <div class="position-relative mx-auto">
                    <input class="form-control border-primary rounded-pill w-100 py-3 ps-4 pe-5" type="text"
                        placeholder="Your email">
                    <button type="button"
                        class="btn btn-primary rounded-pill position-absolute top-0 end-0 py-2 px-4 mt-2 me-2">Subscribe</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Subscribe End -->

    <!-- Copyright Start -->
    <div class="container-fluid copyright text-body py-4">
        <div class="container">
            <div class="row g-4 align-items-center">
                <div class="col-md-6 text-center text-md-end mb-md-0">
                    <i class="fas fa-copyright me-2"></i><a class="text-white" href="./index.html">Ayubowan Tours</a>,
                    All right reserved.
                </div>
            </div>
        </div>
    </div>
    <!-- Copyright End -->

    <!-- whatsapp button -->
    <a href="https://wa.me/94763661600?text=Welcome%20to%20Ayubowan%20Tours.%20How%20can%20we%20assist?%20you%3F"
        class="whatsapp-float" target="_blank">
        <i class="fa-brands fa-whatsapp"></i>
    </a>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Hide spinner immediately
            const spinner = document.getElementById('spinner');
            spinner.style.display = 'none';

            // Initialize the application
            initializeApp();
        });

        // Main initialization function
        function initializeApp() {
            // ==================== VARIABLES ====================
            const coords = {
                Kandy: [7.2906, 80.6337],
                Sigiriya: [7.9570, 80.7603],
                Ella: [6.8667, 81.0466],
                Yala: [6.3667, 81.5167],
                Galle: [6.0535, 80.2210]
            };

            const colors = ['#1abc9c', '#3498db', '#9b59b6', '#e67e22', '#e74c3c', '#f1c40f', '#2ecc71', '#34495e'];

            // Get DOM elements
            const availableGrid = document.getElementById('availableGrid');
            const selectedGrid = document.getElementById('selectedGrid');
            const sendWhatsApp = document.getElementById('sendWhatsApp');
            const sendEmail = document.getElementById('sendEmail');
            const generatePDF = document.getElementById('generatePDF');
            const popupOverlay = document.getElementById('popupOverlay');
            const downloadSummaryPDF = document.getElementById('downloadSummaryPDF');
            const mapForExport = document.getElementById('mapForExport');
            const availableEmptyMessage = document.getElementById('availableEmptyMessage');
            const selectedEmptyMessage = document.getElementById('selectedEmptyMessage');
            const countdownElement = document.getElementById('countdown');

            // Form inputs
            const name = document.getElementById('name');
            const phone = document.getElementById('phone');
            const email = document.getElementById('email');
            const adults = document.getElementById('adults');
            const children = document.getElementById('children');
            const arrival = document.getElementById('arrival');
            const departure = document.getElementById('departure');

            // State variables
            let map = null;
            let routeControl = null;
            let markers = [];
            let exportMap = null;
            let exportRouteControl = null;
            let exportMarkers = [];
            let draggedItem = null;
            let isBookingConfirmed = false;
            let countdownTimer = null;

            // ==================== INITIALIZE MAP ====================
            function initializeMap() {
                try {
                    map = L.map('map').setView(coords.Kandy, 7);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://openstreetmap.org">OSM</a> contributors'
                    }).addTo(map);
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }

            // ==================== EMPTY STATE MESSAGES ====================
            function updateEmptyStates() {
                // Available destinations empty state
                if (availableGrid.children.length === 0) {
                    availableEmptyMessage.style.display = 'block';
                } else {
                    availableEmptyMessage.style.display = 'none';
                }

                // Selected destinations empty state
                if (selectedGrid.children.length === 0) {
                    selectedEmptyMessage.style.display = 'block';
                } else {
                    selectedEmptyMessage.style.display = 'none';
                }
            }

            // ==================== DRAG AND DROP FUNCTIONALITY ====================
            function setupDragAndDrop() {
                const items = document.querySelectorAll('.item');

                items.forEach(item => {
                    item.setAttribute('draggable', 'true');

                    item.addEventListener('dragstart', function (e) {
                        draggedItem = this;
                        this.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', this.dataset.id);
                    });

                    item.addEventListener('dragend', function () {
                        this.classList.remove('dragging');
                        draggedItem = null;
                        updateEmptyStates();
                    });

                    // Click functionality
                    item.addEventListener('click', function (e) {
                        if (e.target.classList.contains('dragging')) return;

                        const target = this.parentElement.id === 'availableGrid' ? selectedGrid : availableGrid;
                        target.appendChild(this);
                        saveToLocalStorage();
                        updateRouteMap();
                        validateForm();
                        updateEmptyStates();
                    });
                });

                [availableGrid, selectedGrid].forEach(container => {
                    container.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        this.style.backgroundColor = '#f0f8ff';
                    });

                    container.addEventListener('dragleave', function () {
                        this.style.backgroundColor = '';
                    });

                    container.addEventListener('drop', function (e) {
                        e.preventDefault();
                        this.style.backgroundColor = '';

                        if (draggedItem && draggedItem.parentElement !== this) {
                            this.appendChild(draggedItem);
                            saveToLocalStorage();
                            updateRouteMap();
                            validateForm();
                            updateEmptyStates();
                        }
                    });
                });
            }

            // ==================== LOCAL STORAGE ====================
            function saveToLocalStorage() {
                const selectedItems = [...selectedGrid.children];
                const selectedIds = selectedItems.map(item => item.dataset.id);
                localStorage.setItem('selectedJourney', JSON.stringify(selectedIds));
            }

            function loadFromLocalStorage() {
                try {
                    const savedSelection = localStorage.getItem('selectedJourney');
                    if (savedSelection) {
                        const selectedIds = JSON.parse(savedSelection);
                        selectedIds.forEach(id => {
                            const item = document.querySelector(`.item[data-id="${id}"]`);
                            if (item && item.parentElement && item.parentElement.id === 'availableGrid') {
                                selectedGrid.appendChild(item);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
                updateRouteMap();
                validateForm();
                updateEmptyStates();
            }

            function clearLocalStorageAndReload() {
                // Clear all booking-related data
                localStorage.removeItem('selectedJourney');
                localStorage.removeItem('lastBooking');

                // Reset booking state
                isBookingConfirmed = false;

                // Reload page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            }

            // ==================== MAP FUNCTIONALITY ====================
            function createPinIcon(number) {
                const color = colors[(number - 1) % colors.length];
                return L.divIcon({
                    html: `<div class="pin-icon" style="background:${color}">${number}</div>`,
                    className: '',
                    iconSize: [36, 46],
                    iconAnchor: [18, 46]
                });
            }

            function updateRouteMap() {
                // Clear existing markers and route
                markers.forEach(m => {
                    if (m && map) map.removeLayer(m);
                });
                markers = [];
                if (routeControl && map) {
                    map.removeControl(routeControl);
                    routeControl = null;
                }

                // If no items selected, show default view
                if (selectedGrid.children.length < 1) {
                    if (map) map.setView(coords.Kandy, 7);
                    return;
                }

                // Create waypoints from selected items
                const waypoints = [...selectedGrid.children].map(i => L.latLng(coords[i.dataset.id]));

                // Add markers for each waypoint
                waypoints.forEach((wp, i) => {
                    const marker = L.marker(wp, { icon: createPinIcon(i + 1) }).addTo(map);
                    markers.push(marker);
                });

                // Add routing if more than one waypoint
                if (waypoints.length > 1 && typeof L.Routing !== 'undefined') {
                    try {
                        routeControl = L.Routing.control({
                            waypoints: waypoints,
                            lineOptions: { styles: [{ color: 'blue', weight: 4 }] },
                            createMarker: () => null,
                            routeWhileDragging: false,
                            addWaypoints: false,
                            draggableWaypoints: false,
                            show: false
                        }).addTo(map);
                    } catch (error) {
                        console.error('Error adding routing control:', error);
                    }
                }

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.2));
                }
            }

            // ==================== FORM VALIDATION ====================
            function showValidationMessage(id, show, message) {
                const msgElement = document.getElementById(id);
                if (msgElement) {
                    msgElement.textContent = message;
                    if (show) {
                        msgElement.classList.add('show');
                    } else {
                        msgElement.classList.remove('show');
                    }
                }
            }

            function validateField(fieldId, condition, msgId, errorMessage) {
                const isValid = condition;
                const field = document.getElementById(fieldId);

                if (field) {
                    if (isValid) {
                        field.classList.remove('invalid');
                        field.classList.add('valid');
                        showValidationMessage(msgId, false, '');
                    } else {
                        field.classList.remove('valid');
                        field.classList.add('invalid');
                        showValidationMessage(msgId, true, errorMessage);
                    }
                }

                return isValid;
            }

            function validateForm() {
                let isFormValid = true;

                // Validate name
                isFormValid &= validateField(
                    'name',
                    name && name.value.trim() !== '',
                    'nameMsg',
                    'Please enter your full name'
                );

                // Validate phone (7-15 digits)
                isFormValid &= validateField(
                    'phone',
                    phone && /^[0-9]{7,15}$/.test(phone.value),
                    'phoneMsg',
                    'Please enter a valid phone number (7-15 digits)'
                );

                // Validate email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                isFormValid &= validateField(
                    'email',
                    email && emailRegex.test(email.value),
                    'emailMsg',
                    'Please enter a valid email address'
                );

                // Validate adults
                isFormValid &= validateField(
                    'adults',
                    adults && parseInt(adults.value) >= 1,
                    'adultsMsg',
                    'At least 1 adult is required'
                );

                // Validate arrival date
                isFormValid &= validateField(
                    'arrival',
                    arrival && arrival.value !== '',
                    'arrivalMsg',
                    'Please select an arrival date'
                );

                // Validate departure date
                let departureValid = false;
                if (arrival && arrival.value !== '' && departure && departure.value !== '') {
                    const arrivalDate = new Date(arrival.value);
                    const departureDate = new Date(departure.value);
                    departureValid = departureDate > arrivalDate;
                }

                isFormValid &= validateField(
                    'departure',
                    departureValid,
                    'departureMsg',
                    'Please select a departure date after arrival date'
                );

                // Check if at least one destination is selected
                const hasDestinations = selectedGrid.children.length > 0;

                // Enable/disable buttons (PDF button is disabled after booking)
                const allValid = isFormValid && hasDestinations;
                if (sendWhatsApp) sendWhatsApp.disabled = !allValid || isBookingConfirmed;
                if (sendEmail) sendEmail.disabled = !allValid || isBookingConfirmed;
                if (generatePDF) generatePDF.disabled = !allValid || isBookingConfirmed;

                return allValid;
            }

            // ==================== WHATSAPP MESSAGE ====================
            function getSelectedDestinations() {
                return [...selectedGrid.children].map((item, index) =>
                    `${index + 1}. ${item.dataset.id}`
                ).join('\n');
            }

            function createWhatsAppMessage() {
                const destinations = getSelectedDestinations();

                return `ðŸš€ *Ayubowan Tours - Booking Request* ðŸš€

*Customer Details:*
ðŸ‘¤ *Name:* ${name.value.trim()}
ðŸ“ž *Phone:* ${phone.value}
ðŸ“§ *Email:* ${email.value}
ðŸ‘¥ *Adults:* ${adults.value}
ðŸ‘¶ *Children:* ${children.value}
ðŸ“… *Arrival Date:* ${arrival.value}
ðŸ“… *Departure Date:* ${departure.value}

*Selected Itinerary:*
${destinations}

*Total Destinations:* ${selectedGrid.children.length}

I would like to book this tour. Please provide me with pricing and availability.`;
            }

            // ==================== ATTRACTIVE PDF GENERATION ====================
            async function generateAttractivePDF(button) {
                if (!validateForm()) return;

                // Show loading state if button exists
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating Beautiful PDF...';
                    button.disabled = true;

                    try {
                        await generatePDFContent();
                    } finally {
                        // Restore button state
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                } else {
                    await generatePDFContent();
                }
            }

            async function generatePDFContent() {
                try {
                    // Generate PDF
                    if (typeof window.jspdf === 'undefined') {
                        throw new Error('PDF library not loaded');
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // ===== PAGE 1: COVER PAGE =====
                    // Background gradient
                    doc.setFillColor(102, 126, 234);
                    doc.rect(0, 0, 210, 297, 'F');

                    // Logo/Header
                    doc.setFontSize(32);
                    doc.setTextColor(255, 255, 255);
                    doc.text("Ayubowan Tours", 105, 40, { align: 'center' });

                    // Subtitle
                    doc.setFontSize(18);
                    doc.text("Booking Summary", 105, 60, { align: 'center' });

                    // Decorative line
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(0.5);
                    doc.line(60, 70, 150, 70);

                    // Booking ID
                    const bookingId = 'AYT' + Date.now().toString().slice(-8);
                    doc.setFontSize(12);
                    doc.text(`Booking ID: ${bookingId}`, 105, 85, { align: 'center' });

                    // Customer name
                    doc.setFontSize(24);
                    doc.text(name.value.trim(), 105, 110, { align: 'center' });

                    // Destination count
                    doc.setFontSize(16);
                    doc.text(`${selectedGrid.children.length} Amazing Destinations`, 105, 130, { align: 'center' });

                    // Travel dates
                    doc.setFontSize(14);
                    doc.text(`${arrival.value} to ${departure.value}`, 105, 150, { align: 'center' });

                    // Footer note
                    doc.setFontSize(10);
                    doc.text("Your Sri Lankan adventure awaits!", 105, 180, { align: 'center' });

                    // Generated date
                    doc.text(`Generated on: ${new Date().toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}`, 105, 280, { align: 'center' });

                    // ===== PAGE 2: DETAILS PAGE =====
                    doc.addPage();

                    // Page title
                    doc.setFillColor(255, 255, 255);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(20);
                    doc.text("Travel Details", 105, 20, { align: 'center' });

                    // Section: Customer Information
                    doc.setFontSize(16);
                    doc.setTextColor(102, 126, 234);
                    doc.text("ðŸ‘¤ Customer Information", 10, 35);

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    let yPos = 45;

                    // Create info table
                    const customerInfo = [
                        ['Name:', name.value.trim()],
                        ['Phone:', phone.value],
                        ['Email:', email.value],
                        ['Travelers:', `${adults.value} Adult(s), ${children.value || '0'} Child(ren)`],
                        ['Dates:', `${arrival.value} to ${departure.value}`]
                    ];

                    customerInfo.forEach(([label, value]) => {
                        doc.setFont(undefined, 'bold');
                        doc.text(label, 15, yPos);
                        doc.setFont(undefined, 'normal');
                        doc.text(value, 50, yPos);
                        yPos += 8;
                    });

                    // Section: Itinerary
                    yPos += 10;
                    doc.setFontSize(16);
                    doc.setTextColor(102, 126, 234);
                    doc.text("ðŸ—ºï¸ Your Itinerary", 10, yPos);

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    yPos += 10;

                    const destinations = [...selectedGrid.children];
                    destinations.forEach((item, index) => {
                        doc.setFillColor(colors[index % colors.length]);
                        doc.circle(18, yPos - 4, 3, 'F');
                        doc.text(`${index + 1}. ${item.dataset.id}`, 25, yPos);
                        yPos += 7;
                    });

                    // ===== PAGE 3: MAP DESCRIPTION =====
                    doc.addPage();

                    // Page title
                    doc.setFontSize(20);
                    doc.text("Your Travel Route", 105, 20, { align: 'center' });

                    // Map description
                    yPos = 40;
                    doc.setFontSize(12);
                    doc.text("Your selected destinations in Sri Lanka:", 10, yPos);

                    yPos += 10;
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text("ðŸ“ Route Highlights:", 10, yPos);

                    yPos += 8;
                    doc.text("â€¢ Blue line shows your travel route", 15, yPos);
                    yPos += 5;
                    doc.text("â€¢ Numbered pins indicate destinations in order", 15, yPos);
                    yPos += 5;
                    doc.text("â€¢ Optimal route calculated for your journey", 15, yPos);

                    // Footer with contact info
                    yPos = 280;
                    doc.setFontSize(9);
                    doc.text("Ayubowan Tours - Discover the Wonder of Sri Lanka", 105, yPos, { align: 'center' });
                    yPos += 4;
                    doc.text("ðŸ“ž +94 76 366 1600 | âœ‰ï¸ info@ayubowantours.com", 105, yPos, { align: 'center' });

                    // ===== SAVE PDF =====
                    const fileName = `Ayubowan_Tour_Booking_${name.value.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
                    doc.save(fileName);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            }

            // ==================== EMAIL FUNCTION ====================
            function sendBookingEmail() {
                const destinations = getSelectedDestinations();
                const subject = `Booking Request - ${name.value.trim()} - Ayubowan Tours`;
                const body = `Dear Ayubowan Tours Team,

I would like to request a booking with the following details:

CUSTOMER INFORMATION:
- Name: ${name.value.trim()}
- Phone: ${phone.value}
- Email: ${email.value}
- Adults: ${adults.value}
- Children: ${children.value || '0'}
- Arrival Date: ${arrival.value}
- Departure Date: ${departure.value}

SELECTED DESTINATIONS:
${destinations}

Total Destinations: ${selectedGrid.children.length}

Please contact me to discuss this booking request further.

Best regards,
${name.value.trim()}`;

                const encodedSubject = encodeURIComponent(subject);
                const encodedBody = encodeURIComponent(body);

                window.location.href = `mailto:info@ayubowantours.com?subject=${encodedSubject}&body=${encodedBody}`;
            }

            // ==================== BOOKING CONFIRMATION ====================
            function showBookingConfirmation() {
                isBookingConfirmed = true;

                // Disable form inputs
                [name, phone, email, adults, children, arrival, departure].forEach(field => {
                    if (field) field.disabled = true;
                });

                // Disable booking buttons
                if (sendWhatsApp) sendWhatsApp.disabled = true;
                if (sendEmail) sendEmail.disabled = true;
                if (generatePDF) generatePDF.disabled = true;

                // Start countdown
                let seconds = 5;
                if (countdownElement) countdownElement.textContent = seconds;

                countdownTimer = setInterval(() => {
                    seconds--;
                    if (countdownElement) countdownElement.textContent = seconds;

                    if (seconds <= 0) {
                        clearInterval(countdownTimer);
                        closePopupAndReset();
                    }
                }, 1000);

                // Show popup
                if (popupOverlay) popupOverlay.style.display = 'flex';
            }

            function closePopupAndReset() {
                clearInterval(countdownTimer);
                if (popupOverlay) popupOverlay.style.display = 'none';
                clearLocalStorageAndReload();
            }

            // ==================== EVENT LISTENERS ====================
            function setupEventListeners() {
                // Form input validation
                [name, phone, email, adults, children, arrival, departure].forEach(field => {
                    if (field) {
                        field.addEventListener('input', validateForm);
                        field.addEventListener('change', validateForm);
                    }
                });

                // Date validation constraints
                const today = new Date().toISOString().split('T')[0];
                if (arrival) {
                    arrival.min = today;
                    arrival.addEventListener('change', function () {
                        if (this.value && departure) {
                            departure.min = this.value;
                            if (departure.value && departure.value < this.value) {
                                departure.value = '';
                            }
                        }
                        validateForm();
                    });
                }

                if (departure) {
                    departure.min = today;
                }

                // WhatsApp booking button
                if (sendWhatsApp) {
                    sendWhatsApp.addEventListener('click', function () {
                        if (!validateForm()) return;

                        const message = createWhatsAppMessage();
                        const encodedMessage = encodeURIComponent(message);
                        const whatsappUrl = `https://wa.me/94763661600?text=${encodedMessage}`;

                        // Save booking data
                        const bookingData = {
                            name: name.value.trim(),
                            phone: phone.value,
                            email: email.value,
                            adults: adults.value,
                            children: children.value || '0',
                            arrival: arrival.value,
                            departure: departure.value,
                            destinations: [...selectedGrid.children].map(item => item.dataset.id),
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem('lastBooking', JSON.stringify(bookingData));

                        // Open WhatsApp
                        window.open(whatsappUrl, '_blank');

                        // Show confirmation with download button
                        setTimeout(() => {
                            showBookingConfirmation();
                        }, 500);
                    });
                }

                // Email booking button
                if (sendEmail) {
                    sendEmail.addEventListener('click', function () {
                        if (!validateForm()) return;
                        sendBookingEmail();
                    });
                }

                // Regular PDF button (disabled in form)
                if (generatePDF) {
                    generatePDF.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (!validateForm()) return;
                        generateAttractivePDF(this);
                    });
                }

                // Download summary PDF button (in popup)
                if (downloadSummaryPDF) {
                    downloadSummaryPDF.addEventListener('click', function (e) {
                        e.preventDefault();
                        generateAttractivePDF(this);
                    });
                }

                // Close popup when clicking outside
                if (popupOverlay) {
                    popupOverlay.addEventListener('click', function (e) {
                        if (e.target === this) {
                            closePopupAndReset();
                        }
                    });
                }
            }

            // ==================== MAIN INITIALIZATION ====================
            function initialize() {
                // Initialize map
                initializeMap();

                // Setup drag and drop
                setupDragAndDrop();

                // Load saved data
                loadFromLocalStorage();

                // Setup event listeners
                setupEventListeners();

                // Initial validation and empty states
                validateForm();
                updateEmptyStates();
            }

            // Start initialization
            initialize();
        }
    </script>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
</body>

</html>